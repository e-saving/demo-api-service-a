name: Build Pipeline to Dev

on:          
  push:
    branches: [ develop ]
    paths-ignore:
      - '.github/**'
      - 'badges/*'
      - 'pom.xml'
      - '*.svg'
      - '*.json'
      - '*.md'
  workflow_dispatch:
  
env:
  SOURCECODE_MANAGE_BRANCH: main

  GITLAB_REPO: git.g-able.com/ais-esaving/service-a.git
  GITLAB_HOME_PATH: service-a
  
  POM_VERSION_LINE_NUMBER: 13
  
  DOCKER_IMAGE_NAME: api-demo-service-a
  
  GITOPS_MANAGE_BRANCH: develop
  GITOPS_MANAGE_HOME_PATH: api-demo-service-a
  
  
jobs:
  generate-version:
    runs-on: ubuntu-latest
    environment: develop
    
    steps:
      - name: Checkout GitOps Repo
        uses: actions/checkout@v2.4.0
        with:
          repository: ${{ secrets.GITOPS_REPO }}
          ref: ${{ env.GITOPS_MANAGE_BRANCH }}
          token: ${{ secrets.GITOPS_TOKEN }}
          path: manage_gitops
      
      - name: Geneate new Build Number
        run: |
            cd manage_gitops/${{ env.GITOPS_MANAGE_HOME_PATH }}
            cur_build_number=$(cat version_control.txt|grep '^BUILD_VERSION'|awk -F'=' '{print($2)}')
            echo "cur_build_number=${cur_build_number}"
            ((new_build_number=cur_build_number+1))
            echo "new_build_number=${new_build_number}"
            echo "BUILD_VERSION=${new_build_number}" > version_control.txt
            echo "BUILD_VERSION=${new_build_number} " >> $GITHUB_ENV

      - name: Checkout Source Code
        run: |
            git clone https://${{ secrets.GITLAB_USERNAME }}:${{ secrets.GITLAB_TOKEN }}@${{ env.GITLAB_REPO }}
            cd ${{ env.GITLAB_HOME_PATH }}
            git switch ${{ env.SOURCECODE_MANAGE_BRANCH }}
                      
      - name: Generate new version
        run: |
            cd ${{ env.GITLAB_HOME_PATH }}
            pom_version=$(head -${{ env.POM_VERSION_LINE_NUMBER }} pom.xml|tail -1|grep -oPm1 "(?<=<version>)[^<]+")
            echo "pom_version=${pom_version}"
            echo "POM_VERSION=${pom_version}" >> ../manage_gitops/${{ env.GITOPS_MANAGE_HOME_PATH }}/version_control.txt
            new_image_version="${pom_version}-${{ env.BUILD_VERSION }}"
            echo "new_image_version=${new_image_version}"
            echo "IMAGE_VERSION=${new_image_version}" >> ../manage_gitops/${{ env.GITOPS_MANAGE_HOME_PATH }}/version_control.txt

      - name: Upload version artifact
        uses: actions/upload-artifact@v1
        with:
          name: version
          path: manage_gitops/${{ env.GITOPS_MANAGE_HOME_PATH }}/version_control.txt   

  build-container:
    runs-on: ubuntu-latest    
    needs: [generate-version]
    environment: develop
    
    steps:    
      - name: Checkout Source Code
        run: |
            git clone https://${{ secrets.GITLAB_USERNAME }}:${{ secrets.GITLAB_TOKEN }}@${{ env.GITLAB_REPO }}
            cd ${{ env.GITLAB_HOME_PATH }}
            git switch ${{ env.SOURCECODE_MANAGE_BRANCH }}
          
      - name: Set up JDK 11
        uses: actions/setup-java@v2
        with:
          java-version: '11'
          distribution: 'adopt'
          
      - name: Download version artifact
        uses: actions/download-artifact@v1
        with:
          name: version

      - name: Check version number
        run: |
          pwd
          ls -l
          img_version=$(cat version/version_control.txt|grep '^IMAGE_VERSION'|awk -F'=' '{print($2)}')
          echo "img_version is ${img_version}"
          echo "IMAGE_VERSION=${img_version} " >> $GITHUB_ENV  
          
      - name: Build with Maven
        run: |
            cd ${{ env.GITLAB_HOME_PATH }}            
            #mkdir -p badges
            #mvn package -Pcoverage
            mvn package            
            #ls -l badges
            ls -l target
            #ls -l target/site/jacoco/      
      
      - name: Scan Source Code Quality (SonarQube)
        env:
           GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}  # Needed to get PR information, if any
           SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
           SONAR_HOST_URL: ${{ secrets.SONAR_HOST_URL }}
        run: |
          cd ${{ env.GITLAB_HOME_PATH }}
          mvn -B verify org.sonarsource.scanner.maven:sonar-maven-plugin:sonar -Dsonar.projectKey=${{ secrets.SONAR_PROJECT_KEY }}
      
      - name: Check Code Quality Gate (SonarQube)
        uses: SonarSource/sonarqube-quality-gate-action@v1.0.0
        timeout-minutes: 5
        env:
         SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        with:
          scanMetadataReportFile: ${{ env.GITLAB_HOME_PATH }}/.scannerwork/report-task.txt
            
      - name: Log in to Azure Container Registry
        uses: azure/docker-login@v1
        with:
            login-server: ${{ secrets.CONTAINER_REGISTRY }}
            username: ${{ secrets.ACR_USERNAME }}
            password: ${{ secrets.ACR_PASSWORD }}

      - name: Build and Push Container Image
        run: |
            cd ${{ env.GITLAB_HOME_PATH }}
            ls -l
            docker build . -t ${{ secrets.CONTAINER_REGISTRY }}/${{ env.DOCKER_IMAGE_NAME }}:${{ env.IMAGE_VERSION }}
            docker push ${{ secrets.CONTAINER_REGISTRY }}/${{ env.DOCKER_IMAGE_NAME }}:${{ env.IMAGE_VERSION }}
          
      - name: Security Scan Container Image (Anchore)
        uses: anchore/scan-action@b08527d5ae7f7dc76f9621edb6e49eaf47933ccd
        with:
          image: "${{ secrets.CONTAINER_REGISTRY }}/${{ env.DOCKER_IMAGE_NAME }}:${{ env.IMAGE_VERSION }}"
          # Generate a SARIF report and set the `sarif` output parameter after successful action execution.  This report is compatible with GitHub Automated Code Scanning (ACS), as the artifact to upload for display as a Code Scanning Alert report.
          acs-report-enable: true
          # Set this to any value to enable verbose debug output
          #debug: # optional, default is false
          # Set to false to avoid failing based on severity-cutoff. Default is to fail when severity-cutoff is reached (or surpassed)
          fail-build: false # optional, default is true      
          # Optionally specify the minimum vulnerability severity to trigger an "error" level ACS result.  Valid choices are "negligible", "low", "medium", "high" and "critical".  Any vulnerability with a severity less than this value will lead to a "warning" result.  Default is "medium".
          severity-cutoff: critical # optional, default is medium

      - name: Upload Container Image Scan Report
        uses: github/codeql-action/upload-sarif@v1
        with:
          sarif_file: results.sarif
